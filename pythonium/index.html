<!doctype html>
<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    </head>

    <body>
        <div class="container">
            <!-- Content here -->

            <h1>Pythonium web visualization</h1>

            <div id="visualization"></div>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="step-input" class="col-form-label">Simulation step</label>
                </div>
                <div class="col-auto">
                    <input id="step-input" type="number" readonly="true" class="form-control">
                </div>
                <div class="col-auto">
                    <input id="fullscreen-input" type="button" class="form-control" value="Fullscreen">
                </div>
            </div>

        </div>

        <footer class="pt-5 my-5 text-muted border-top">
            Created in the PyCamp 2022
        </footer>
    </body>

    <script>
        let data = <!-- DATA PLACEHOLDER -->
    </script>

    <script>
        // Create the application helper and add its render target to the page
        let SIZE = 700;
        let resizeFactor = SIZE / 500;  // 500 is the galaxy size
        let app = new PIXI.Application({ width: SIZE, height: SIZE});
        document.getElementById("visualization").appendChild(app.view);

        const textures = {};
        const playerColors = [0x00AAFF, 0xFFAA00]

        function renderTheGalaxy(simulationStep) {
            data[simulationStep].things.forEach((p, index, array) => {
                let sprite;
                if (p.thing_type == "planet") {
                    sprite = new PIXI.TilingSprite(textures.planets[index % 3]);
                    sprite.anchor.set(0.5);
                    sprite.scale.set(0.15);
                    if (p.player !== null) {
                        sprite.tint = playerColors[0];
                    }
                } else {
                    sprite = new PIXI.TilingSprite(textures.ships[0]);
                    sprite.anchor.set(0.5);
                    sprite.scale.set(0.15);
                    sprite.tint = playerColors[0];
                }
                sprite.position = {
                    x: p.position[0]*resizeFactor,
                    y: p.position[1]*resizeFactor
                };
                app.stage.addChild(sprite);
            });
        }

        function main() {
            let N_STEPS = data.length;
            let DEFAULT_DELAY = 500;  // milliseconds
            var counter = 0;
            let stepInputElem = document.getElementById("step-input");

            var idTimeout = window.setInterval(
                function(){
                    // Every `DEFAULT_DELAY` milliseconds clear the Galaxy
                    // and render the simulation step given by `counter`
                    app.stage.removeChildren();
                    let step = counter % N_STEPS;
                    renderTheGalaxy(step);
                    stepInputElem.value = step;
                    counter++;
                },
                DEFAULT_DELAY
            );
        }

        const loader = PIXI.Loader.shared;
        loader.add('planet01', 'assets/planet01.png');
        loader.add('planet02', 'assets/planet02.png');
        loader.add('planet03', 'assets/planet03.png');
        loader.add('ship01', 'assets/ship01.png');

        loader.load((loader, resources) => {
            textures.planets = [
                resources.planet01.texture,
                resources.planet02.texture,
                resources.planet03.texture,
            ];
            textures.ships = [
                resources.ship01.texture,
            ];
        });
        loader.onComplete.add(main);

        document.getElementById("fullscreen-input").onclick = () => {
            app.view.requestFullscreen();            
        };


    </script>
</html>
